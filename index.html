// ========== æ¯æ—¥å¥–åŠ±å¹¿å‘Šç³»ç»Ÿ ==========
class DailyRewardSystem {
    constructor() {
        this.rewardData = this.loadRewardData();
        this.updateDailyStatus();
    }
    
    loadRewardData() {
        const defaultData = {
            lastClaimDate: null,
            streakDays: 0,
            totalClaims: 0,
            totalEarnings: 0,
            todayRewards: [],
            maxDailyClaims: 3
        };
        
        try {
            const saved = localStorage.getItem('dailyRewardData');
            return saved ? JSON.parse(saved) : defaultData;
        } catch (error) {
            return defaultData;
        }
    }
    
    saveRewardData() {
        try {
            localStorage.setItem('dailyRewardData', JSON.stringify(this.rewardData));
        } catch (error) {
            console.error('ä¿å­˜æ¯æ—¥å¥–åŠ±æ•°æ®å¤±è´¥:', error);
        }
    }
    
    updateDailyStatus() {
        const today = new Date().toDateString();
        
        // å¦‚æœæ—¥æœŸæ”¹å˜ï¼Œé‡ç½®ä»Šæ—¥å¥–åŠ±æ¬¡æ•°
        if (this.rewardData.lastClaimDate !== today) {
            this.rewardData.todayRewards = []; // æ¸…ç©ºä»Šæ—¥å¥–åŠ±è®°å½•
            this.rewardData.lastClaimDate = today;
            
            // å¦‚æœè¿ç»­é¢†å–å¤©æ•°ä¸­æ–­
            if (this.rewardData.lastClaimDate && 
                !this.isYesterday(this.rewardData.lastClaimDate)) {
                this.rewardData.streakDays = 0;
            }
            
            this.saveRewardData();
        }
    }
    
    isYesterday(dateStr) {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        return yesterday.toDateString() === dateStr;
    }
    
    canClaimReward() {
        this.updateDailyStatus();
        
        // æ£€æŸ¥ä»Šæ—¥å¥–åŠ±æ¬¡æ•°
        const todayCount = this.rewardData.todayRewards.length;
        if (todayCount >= this.rewardData.maxDailyClaims) {
            return {
                canClaim: false,
                reason: 'ä»Šæ—¥å¥–åŠ±æ¬¡æ•°å·²è¾¾ä¸Šé™',
                remaining: 0
            };
        }
        
        return {
            canClaim: true,
            reason: 'å¯ä»¥é¢†å–å¥–åŠ±',
            remaining: this.rewardData.maxDailyClaims - todayCount
        };
    }
    
    calculateRewardAmount() {
        const todayCount = this.rewardData.todayRewards.length;
        const streakBonus = Math.min(this.rewardData.streakDays * 0.05, 0.5); // æœ€é«˜+$0.50
        
        let baseAmount = 0.35;
        
        // å¥–åŠ±é€’å¢
        switch (todayCount) {
            case 0: baseAmount = 0.50; break; // ç¬¬ä¸€æ¬¡å¥–åŠ±æœ€é«˜
            case 1: baseAmount = 0.35; break;
            case 2: baseAmount = 0.25; break; // æœ€åä¸€æ¬¡å¥–åŠ±æœ€ä½
        }
        
        return {
            base: baseAmount,
            bonus: streakBonus,
            total: baseAmount + streakBonus
        };
    }
    
    claimReward() {
        const check = this.canClaimReward();
        if (!check.canClaim) {
            return {
                success: false,
                message: check.reason
            };
        }
        
        const reward = this.calculateRewardAmount();
        const claimTime = new Date().toISOString();
        
        // è®°å½•å¥–åŠ±
        this.rewardData.todayRewards.push({
            amount: reward.total,
            time: claimTime,
            streak: this.rewardData.streakDays
        });
        
        this.rewardData.totalClaims++;
        this.rewardData.totalEarnings += reward.total;
        this.rewardData.streakDays++;
        
        this.saveRewardData();
        
        return {
            success: true,
            amount: reward.total,
            streakDays: this.rewardData.streakDays,
            remaining: check.remaining - 1,
            message: `è·å¾—æ¯æ—¥å¥–åŠ± $${reward.total.toFixed(2)} (è¿ç»­${this.rewardData.streakDays}å¤©)`
        };
    }
    
    getRewardInfo() {
        const check = this.canClaimReward();
        const reward = this.calculateRewardAmount();
        
        return {
            canClaim: check.canClaim,
            remainingClaims: check.remaining,
            streakDays: this.rewardData.streakDays,
            todayClaims: this.rewardData.todayRewards.length,
            totalClaims: this.rewardData.totalClaims,
            totalEarnings: this.rewardData.totalEarnings,
            nextRewardAmount: reward.total,
            maxDailyClaims: this.rewardData.maxDailyClaims
        };
    }
    
    resetStreak() {
        this.rewardData.streakDays = 0;
        this.saveRewardData();
    }
}

// ========== åˆå§‹åŒ–æ¯æ—¥å¥–åŠ±ç³»ç»Ÿ ==========
let dailyRewardSystem;

// ========== æ˜¾ç¤ºæ¯æ—¥å¥–åŠ±å¹¿å‘Š ==========
function showDailyRewarded() {
    if (!dailyRewardSystem) {
        dailyRewardSystem = new DailyRewardSystem();
    }
    
    const rewardInfo = dailyRewardSystem.getRewardInfo();
    
    if (!rewardInfo.canClaim) {
        showNotification(`âš ï¸ ${rewardInfo.remainingClaims <= 0 ? 'ä»Šæ—¥å¥–åŠ±æ¬¡æ•°å·²è¾¾ä¸Šé™' : rewardInfo.reason}`, '#FF9800');
        return;
    }
    
    // æ£€æŸ¥å†·å´æ—¶é—´
    if (!checkCooldown('daily')) return;
    
    console.log('ğŸ® æ˜¾ç¤ºæ¯æ—¥å¥–åŠ±å¹¿å‘Š');
    
    // æ˜¾ç¤ºæ¯æ—¥å¥–åŠ±ä¿¡æ¯ç•Œé¢
    showDailyRewardInfo(rewardInfo);
}

// ========== æ˜¾ç¤ºæ¯æ—¥å¥–åŠ±ä¿¡æ¯ç•Œé¢ ==========
function showDailyRewardInfo(rewardInfo) {
    const overlay = document.createElement('div');
    overlay.id = 'daily-reward-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.95);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
    `;
    
    const reward = dailyRewardSystem.calculateRewardAmount();
    
    overlay.innerHTML = `
        <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); color: white; border-radius: 20px; padding: 30px; max-width: 450px; width: 100%; text-align: center; border: 2px solid #FFD700;">
            <button onclick="closeDailyRewardInfo()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; color: white; font-size: 20px; cursor: pointer;">Ã—</button>
            
            <div style="font-size: 50px; margin-bottom: 20px;">ğŸ</div>
            <h2 style="color: #FFD700;">æ¯æ—¥å¥–åŠ±</h2>
            <p style="opacity: 0.8; margin-bottom: 25px;">è¿ç»­é¢†å–å¥–åŠ±åŠ å€</p>
            
            <!-- è¿ç»­é¢†å–ä¿¡æ¯ -->
            <div style="background: rgba(255, 215, 0, 0.1); padding: 20px; border-radius: 15px; margin: 15px 0; border: 1px solid rgba(255, 215, 0, 0.3);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 12px; opacity: 0.7;">è¿ç»­é¢†å–</div>
                        <div style="font-size: 24px; font-weight: bold; color: #FFD700;">
                            ${rewardInfo.streakDays} <span style="font-size: 14px;">å¤©</span>
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 12px; opacity: 0.7;">ä»Šæ—¥è¿›åº¦</div>
                        <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">
                            ${rewardInfo.todayClaims}/${rewardInfo.maxDailyClaims}
                        </div>
                    </div>
                </div>
                
                <!-- è¿ç»­å¤©æ•°è¿›åº¦ -->
                <div style="margin: 15px 0;">
                    <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px;">
                        <span>è¿ç»­å¥–åŠ±</span>
                        <span>+$${reward.bonus.toFixed(2)}</span>
                    </div>
                    <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                        <div style="width: ${Math.min(rewardInfo.streakDays * 10, 100)}%; height: 100%; background: linear-gradient(90deg, #FFD700, #FFA500); border-radius: 4px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- å¥–åŠ±é‡‘é¢ -->
            <div style="background: rgba(76, 175, 80, 0.2); padding: 25px; border-radius: 15px; margin: 25px 0; border: 1px solid rgba(76, 175, 80, 0.5);">
                <div style="font-size: 14px; opacity: 0.8; margin-bottom: 10px;">æœ¬æ¬¡å¥–åŠ±é‡‘é¢</div>
                <div style="display: flex; justify-content: space-between; align-items: baseline;">
                    <div>
                        <div style="font-size: 12px; opacity: 0.7;">åŸºç¡€å¥–åŠ±</div>
                        <div style="color: #4CAF50;">$${reward.base.toFixed(2)}</div>
                    </div>
                    <div style="font-size: 24px; font-weight: bold;">+</div>
                    <div>
                        <div style="font-size: 12px; opacity: 0.7;">è¿ç»­å¥–åŠ±</div>
                        <div style="color: #FFD700;">$${reward.bonus.toFixed(2)}</div>
                    </div>
                    <div style="font-size: 24px; font-weight: bold;">=</div>
                    <div>
                        <div style="font-size: 12px; opacity: 0.7;">æ€»å¥–åŠ±</div>
                        <div style="color: #FF9800; font-size: 36px; font-weight: bold;">$${reward.total.toFixed(2)}</div>
                    </div>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <button onclick="startDailyRewardAd()" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #333; border: none; padding: 18px 30px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 10px;">
                    ğŸ é¢†å–æ¯æ—¥å¥–åŠ± ($${reward.total.toFixed(2)})
                </button>
                
                <div style="font-size: 12px; opacity: 0.7;">
                    æ¯æ—¥å¯é¢†å– ${rewardInfo.maxDailyClaims} æ¬¡å¥–åŠ±ï¼Œè¿ç»­é¢†å–å¥–åŠ±é€’å¢
                </div>
            </div>
            
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; font-size: 12px;">
                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px;">
                    <div style="opacity: 0.7;">æ€»é¢†å–æ¬¡æ•°</div>
                    <div style="font-weight: bold; color: #4CAF50;">${rewardInfo.totalClaims}</div>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px;">
                    <div style="opacity: 0.7;">ç´¯è®¡æ”¶ç›Š</div>
                    <div style="font-weight: bold; color: #4CAF50;">$${rewardInfo.totalEarnings.toFixed(2)}</div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(overlay);
}

// ========== å¼€å§‹æ¯æ—¥å¥–åŠ±å¹¿å‘Š ==========
function startDailyRewardAd() {
    closeDailyRewardInfo();
    
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥é¢†å–
    const check = dailyRewardSystem.canClaimReward();
    if (!check.canClaim) {
        showNotification(check.reason, '#FF9800');
        return;
    }
    
    // æ˜¾ç¤ºå¹¿å‘Šç•Œé¢
    const reward = dailyRewardSystem.calculateRewardAmount();
    showAdInterface('daily', reward.total);
}

// ========== å…³é—­æ¯æ—¥å¥–åŠ±ä¿¡æ¯ ==========
function closeDailyRewardInfo() {
    const overlay = document.getElementById('daily-reward-overlay');
    if (overlay) {
        overlay.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            if (overlay.parentNode) {
                document.body.removeChild(overlay);
            }
        }, 300);
    }
}

// ========== æ›´æ–°æ¯æ—¥å¥–åŠ±æŒ‰é’®çŠ¶æ€ ==========
function updateDailyRewardButton() {
    if (!dailyRewardSystem) return;
    
    const rewardInfo = dailyRewardSystem.getRewardInfo();
    const button = document.getElementById('btn-daily');
    
    if (button) {
        if (rewardInfo.canClaim) {
            const remaining = rewardInfo.maxDailyClaims - rewardInfo.todayClaims;
            button.disabled = false;
            button.innerHTML = `ğŸ® æ¯æ—¥å¥–åŠ± (å‰©ä½™${remaining}æ¬¡)`;
        } else {
            button.disabled = true;
            button.innerHTML = 'ğŸ® ä»Šæ—¥å¥–åŠ±å·²é¢†å®Œ';
        }
    }
}

// ========== åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ¯æ—¥å¥–åŠ±ç³»ç»Ÿ ==========
function initDailyRewardSystem() {
    dailyRewardSystem = new DailyRewardSystem();
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    updateDailyRewardButton();
    
    // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    setInterval(() => {
        if (dailyRewardSystem) {
            dailyRewardSystem.updateDailyStatus();
            updateDailyRewardButton();
        }
    }, 60000);
}

// ========== ä¿®æ”¹completeAdå‡½æ•°ï¼Œæ·»åŠ æ¯æ—¥å¥–åŠ±å¤„ç† ==========
function completeAd(adType, earnings) {
    closeAdInterface();
    
    // è®¾ç½®å†·å´æ—¶é—´
    gameData.cooldowns[adType] = adType === 'daily' ? 0 : 30000; // 30ç§’å†·å´
    
    // æ›´æ–°æ•°æ®
    gameData.impressions++;
    gameData.clicks++;
    gameData.todayEarnings += earnings;
    gameData.totalEarnings += earnings;
    
    // å¦‚æœæ˜¯æ¯æ—¥å¥–åŠ±ï¼Œè®°å½•é¢†å–
    if (adType === 'daily' && dailyRewardSystem) {
        const result = dailyRewardSystem.claimReward();
        if (result.success) {
            // ä½¿ç”¨æ¯æ—¥å¥–åŠ±ç³»ç»Ÿçš„å®é™…é‡‘é¢
            gameData.todayEarnings = gameData.todayEarnings - earnings + result.amount;
            gameData.totalEarnings = gameData.totalEarnings - earnings + result.amount;
            earnings = result.amount; // æ›´æ–°æ˜¾ç¤ºçš„æ”¶ç›Šé‡‘é¢
            
            // æ˜¾ç¤ºç‰¹æ®Šé€šçŸ¥
            showNotification(`ğŸ ${result.message}`, '#FFD700');
            
            // æ›´æ–°æ¯æ—¥å¥–åŠ±æŒ‰é’®
            updateDailyRewardButton();
        }
    }
    
    // æ›´æ–°UI
    updateGameStats();
    
    // æ˜¾ç¤ºé€šçŸ¥
    if (adType !== 'daily') {
        showNotification(`ğŸ‰ å¹¿å‘Šå®Œæˆï¼ +$${earnings.toFixed(2)}`, '#4CAF50');
    }
    
    // å¯ç”¨æŒ‰é’®ï¼ˆé™¤äº†å†·å´ä¸­çš„ï¼‰
    disableAdButtons(false);
    
    // å¼€å§‹å†·å´è®¡æ—¶
    startCooldownTimer(adType);
}

// ========== åœ¨é¡µé¢åŠ è½½æ—¶è°ƒç”¨åˆå§‹åŒ– ==========
// ä¿®æ”¹window.onloadéƒ¨åˆ†ï¼Œæ·»åŠ ï¼š
window.addEventListener('load', function() {
    console.log('ğŸ® AdMobçœŸå®æ”¶ç›Šæ¸¸æˆåŠ è½½å®Œæˆ');
    console.log('ğŸ“Š ä½ çš„é…ç½®:', ADMOB_CONFIG);
    
    // åŠ è½½æ•°æ®
    loadGameData();
    
    // åˆå§‹åŒ–æ¯æ—¥å¥–åŠ±ç³»ç»Ÿ
    initDailyRewardSystem();
    
    // åˆå§‹åŒ–AdMob
    setTimeout(initAdMob, 1000);
    
    // æ·»åŠ åŠ¨ç”»æ ·å¼
    if (!document.getElementById('anim-styles')) {
        const style = document.createElement('style');
        style.id = 'anim-styles';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);
    }
    
    // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
    setTimeout(() => {
        showNotification('ğŸ‰ AdMobé…ç½®å®Œæˆï¼ç­‰å¾…å®¡æ ¸é€šè¿‡å³å¯å¼€å§‹çœŸå®æ”¶ç›Šï¼', '#4CAF50');
        
        // æ£€æŸ¥æ¯æ—¥å¥–åŠ±çŠ¶æ€
        if (dailyRewardSystem) {
            const rewardInfo = dailyRewardSystem.getRewardInfo();
            if (rewardInfo.remainingClaims > 0) {
                setTimeout(() => {
                    showNotification(`ğŸ ä»Šæ—¥è¿˜æœ‰ ${rewardInfo.remainingClaims} æ¬¡æ¯æ—¥å¥–åŠ±å¯é¢†å–ï¼`, '#FFD700');
                }, 2000);
            }
        }
    }, 2000);
});
